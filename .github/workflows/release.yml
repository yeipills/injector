name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build_and_release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0.x

    - name: Restore dependencies
      run: dotnet restore injector\injector.csproj

    - name: Build
      run: dotnet build injector\injector.csproj --configuration Release --no-restore

    - name: Publish
      run: dotnet publish injector\injector.csproj --configuration Release --no-build --output ./publish

    - name: Archive files
      run: Compress-Archive -Path ./publish/* -DestinationPath ./injector.zip

    - name: Get version from tag
      id: get_version
      run: |
        if ("${{ github.ref }}" -match "refs/tags/(.*)") {
          $version = $matches[1]
        } else {
          $version = "dev-build"
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Create Release and Upload Asset
      uses: softprops/action-gh-release@v1
      with:
        files: ./injector.zip
        tag_name: ${{ steps.get_version.outputs.version }}
        name: Release ${{ steps.get_version.outputs.version }}
        draft: false
        prerelease: false
        body: |
          ## DLL Injector - ${{ steps.get_version.outputs.version }}

          Professional and secure DLL injection tool for Windows.

          ### Features
          - Process enumeration
          - Safe DLL injection with validation
          - Architecture matching (32-bit/64-bit)
          - PE file validation
          - Comprehensive error handling

          ### Requirements
          - Windows 7 or later
          - .NET 6.0 Runtime
          - Administrator privileges

          ### Installation
          1. Download `injector.zip`
          2. Extract to your desired location
          3. Run `injector.exe` as Administrator

          See [README.md](https://github.com/yeipills/injector/blob/master/README.md) for full documentation.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
